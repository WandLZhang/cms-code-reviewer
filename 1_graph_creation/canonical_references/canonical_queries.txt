/*
------------------------------------------------------------------------------
 CANONICAL QUERIES (GQL)
------------------------------------------------------------------------------

1. LIFE OF A TRANSACTION ("The Policy Map & Data Lineage")
   "Show the sequence of validation gates a transaction must pass through, including the specific data interactions."
   
   Context: "Map the 'Process Transaction' flow to its data checks (Provider/XREF, Beneficiary/Account), revealing both the high-level policy decisions and the low-level data operations."

   -- SIMULATION: "From Square One to Full Trace"
   
   -- Step 0: SOURCE CODE CONTEXT ("The Raw Evidence")
   -- Before any analysis, we retrieve the complete source code.
   -- This gives the LLM or sleuth the full context of what code exists in the program.
   -- Every line is evidence that can be referenced during the investigation.
   GRAPH CobolLineGraph
   MATCH (line:Line)
   RETURN line.line_number AS Line_Number, line.content AS Source_Code
   ORDER BY line.line_number

   -- Step 1: DISCOVERY ("Map the Territory")
   -- We request a high-level map of the program's structure (Divisions and their contents).
   -- This naive query provides the full context for an LLM or developer to identify the logic container (Procedure Division) and entry point.
   GRAPH CobolLineGraph
   MATCH (div:Structure {type: 'DIVISION'})
   OPTIONAL MATCH (div)-[:CONTAINS_CHILD]->(child:Structure)
   RETURN div.name AS Division, child.name AS Content, child.type AS Type
   ORDER BY div.start_line_number, child.start_line_number

   -- Step 2: ASSET INVENTORY ("The 'Red Flag' Check")
   -- Before tracing logic, we survey the program's assets (Files).
   -- We specifically count READS and WRITES to distinguish "Active" assets from "Dead" assets (opened but never used).
   -- A file with 0 Reads/Writes is likely a "Zombie" connection (technical debt).
   GRAPH CobolLineGraph
   MATCH (file:Entity {type: 'FILE'})
   OPTIONAL MATCH (line:Line)-[ref:REFERENCES]->(file)
   RETURN 
     file.name AS File_Name, 
     COUNTIF(ref.usage_type = 'READS') AS Read_Count,
     COUNTIF(ref.usage_type = 'WRITES') AS Write_Count,
     ARRAY_AGG(DISTINCT ref.usage_type) AS All_Operations
   ORDER BY File_Name

   -- Step 3: HIGH-LEVEL FLOW ("What does the main logic do?")
   -- Once we identify 'MAIN-PARA' (from Step 1), we ask: "What subroutines does it orchestrate?"
   GRAPH CobolLineGraph
   MATCH (main:Structure {name: 'MAIN-PARA'})-[:CONTAINS_LINE]->(line:Line)-[:CALLS]->(sub:Structure)
   RETURN DISTINCT sub.name AS Subroutine_Called
   
   -- Step 4: DETAILED TRACE ("The Life of a Transaction")
   -- We trace MAIN-PARA line-by-line AND expand the code of any called subroutines.
   -- We explicitly capture Entity Types (File vs Variable) to distinguish "State Management" from "Data I/O".
   -- This allows us to see if the program is Read-Only (no writes to File entities) or updates the database.
   GRAPH CobolLineGraph
   MATCH (main:Structure {name: 'MAIN-PARA'})-[:CONTAINS_LINE]->(line:Line)
   -- Capture direct references in Main
   OPTIONAL MATCH (line)-[ref:REFERENCES]->(ref_entity:Entity)
   -- Capture subroutine calls AND their internal logic
   OPTIONAL MATCH (line)-[:CALLS]->(sub:Structure)
   OPTIONAL MATCH (sub)-[:CONTAINS_LINE]->(sub_line:Line)
   OPTIONAL MATCH (sub_line)-[sub_ref:REFERENCES]->(sub_entity:Entity)
   RETURN
     line.line_number AS Main_Seq,
     line.content AS Main_Code,
     ref_entity.name AS Main_Ref_Entity,
     ref_entity.type AS Main_Ref_EntType,
     ref.usage_type AS Main_Ref_Op,
     sub.name AS Called_Routine,
     sub_line.content AS Sub_Code,
     sub_entity.name AS Sub_Ref_Entity,
     sub_entity.type AS Sub_Ref_EntType,
     sub_ref.usage_type AS Sub_Ref_Op
   ORDER BY Main_Seq, sub_line.line_number

------------------------------------------------------------------------------
------------------------------------------------------------------------------
 TARGET GRAPH VISUALIZATION (ASCII ART)
------------------------------------------------------------------------------
Query Context: "Life of a Transaction" - Policy Map
Shows the sequence of validation gates a transaction must pass through.

                                   [Structure]
                                 ( MAIN-PARA )
                                       |
            +--------------------------+--------------------------+
            |                                                     |
            | [CALLS]                                             | [CALLS]
            v                                                     v
      [Structure]                                           [Structure]
( 2000-LOOKUP-XREF )                                  ( 3000-READ-ACCOUNT )
            |                                                     |
            +-----------+                                         +-----------+
            |           |                                         |           |
    [READS] |           | [UPDATES]                       [READS] |           | [UPDATES]
            v           v                                         v           v
        [Entity]    [Entity]                                  [Entity]    [Entity]
     ( XREF-FILE ) ( WS-XREF-                                ( ACCT-ID ) ( WS-ACCT-
                     READ-STATUS )                                         READ-STATUS )
                        ^                                                     ^
                        |                                                     |
                        +-----------------------------------------------------+
                                          |
                                     [VALIDATES]
                                          |
                                     ( MAIN-PARA )

------------------------------------------------------------------------------
 GRAPH LEGEND
------------------------------------------------------------------------------
Nodes: ( Name )
 - Structure: COBOL Paragraphs (Logic containers)
 - Entity: Files (Data Stores) or Variables (Data Elements)

Edges: [ TYPE ]
 - CALLS: Control flow transfer (PERFORM)
 - READS: Data ingestion
 - UPDATES: State modification (setting return codes)
 - VALIDATES: Decision logic (IF condition checking the return code)
------------------------------------------------------------------------------
*/
